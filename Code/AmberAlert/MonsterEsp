local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Camera = Workspace.CurrentCamera

-- Global Toggle
_G.MonsterESP_Enabled = true 

local Settings = {
    Box_Color = Color3.fromRGB(255, 0, 0), -- Change this for a different color
    Thickness = 2,
    Folder_Name = "Monsters" -- CHANGE THIS to the folder where your monsters are
}

local ActiveESP = {}

-- Function to create the 8 lines that make the corners
local function CreateBox()
    local lines = {}
    for i = 1, 8 do
        local line = Drawing.new("Line")
        line.Visible = false
        line.Color = Settings.Box_Color
        line.Thickness = Settings.Thickness
        line.Transparency = 1
        lines[i] = line
    end
    return lines
end

local function TrackMonster(model)
    if not model:IsA("Model") or ActiveESP[model] then return end
    
    local lines = CreateBox()
    local connection
    
    connection = RunService.RenderStepped:Connect(function()
        -- Only show if global toggle is ON and model exists
        if _G.MonsterESP_Enabled and model and model.Parent then
            local primary = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
            
            if primary then
                local _, size = model:GetBoundingBox()
                local screenPos, onScreen = Camera:WorldToViewportPoint(primary.Position)

                if onScreen then
                    local dist = (Camera.CFrame.Position - primary.Position).Magnitude
                    -- This 'offset' controls how long the corner brackets are
                    local offset = math.clamp(1/dist * 750, 2, 30) 
                    
                    local top = Camera:WorldToViewportPoint((primary.CFrame * CFrame.new(0, size.Y/2, 0)).Position)
                    local bottom = Camera:WorldToViewportPoint((primary.CFrame * CFrame.new(0, -size.Y/2, 0)).Position)
                    local height = math.abs(top.Y - bottom.Y)
                    local width = height / 1.5

                    -- Corner Points
                    local TL = Vector2.new(screenPos.X - width/2, screenPos.Y - height/2)
                    local TR = Vector2.new(screenPos.X + width/2, screenPos.Y - height/2)
                    local BL = Vector2.new(screenPos.X - width/2, screenPos.Y + height/2)
                    local BR = Vector2.new(screenPos.X + width/2, screenPos.Y + height/2)

                    -- Drawing the 8 segments
                    lines[1].From = TL; lines[1].To = TL + Vector2.new(offset, 0)
                    lines[2].From = TL; lines[2].To = TL + Vector2.new(0, offset)
                    lines[3].From = TR; lines[3].To = TR + Vector2.new(-offset, 0)
                    lines[4].From = TR; lines[4].To = TR + Vector2.new(0, offset)
                    lines[5].From = BL; lines[5].To = BL + Vector2.new(offset, 0)
                    lines[6].From = BL; lines[6].To = BL + Vector2.new(0, -offset)
                    lines[7].From = BR; lines[7].To = BR + Vector2.new(-offset, 0)
                    lines[8].From = BR; lines[8].To = BR + Vector2.new(0, -offset)

                    for _, l in pairs(lines) do l.Visible = true end
                else
                    for _, l in pairs(lines) do l.Visible = false end
                end
            end
        else
            -- Cleanup if disabled or model deleted
            for _, l in pairs(lines) do l.Visible = false end
            
            if not model or not model.Parent then
                for _, l in pairs(lines) do l:Remove() end
                connection:Disconnect()
                ActiveESP[model] = nil
            end
        end
    end)
    
    ActiveESP[model] = true
end

-- Watcher to find the folder and its children
local function InitializeWatcher()
    local folder = Workspace:WaitForChild(Settings.Folder_Name)
    
    for _, child in pairs(folder:GetChildren()) do
        task.spawn(function() TrackMonster(child) end)
    end
    
    folder.ChildAdded:Connect(function(child)
        task.wait(0.5) -- Wait for parts to load
        TrackMonster(child)
    end)
end

task.spawn(InitializeWatcher)

-- Control Functions
_G.EnableMonsterESP = function() _G.MonsterESP_Enabled = true end
_G.DisableMonsterESP = function() _G.MonsterESP_Enabled = false end
